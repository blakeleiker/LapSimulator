%% LAP_SIM
% This script creates a rudimentary lap sim by accounting for the losses in
% lateral acceleration due to lateral load transfer. All the actual work is
% done inside of the function "Lap_Sim_fun.m". This script varies car
% parameters and analyzes their effect on slalom and skidpad times.

%% Define Car Parameters

car = car_struct();

%% Create GUI Figure and all car text boxes 

fig.fh = figure('units','pixels',...
              'position',[400 400 600 360],...
              'menubar','none',...
              'name','Lap Simulator',...
              'numbertitle','off',...
              'resize','off');

fig.title = uicontrol('style','text',...
    'unit','pix',...
    'position',[0 320 fig.fh.Position(3) 22],...
    'min',0,'max',2,...
    'fontsize',22,...
    'string', 'Blake Leiker''s Incredible Lap Simulator',...
    'FontWeight', 'Bold');

fig.W = uicontrol('style','text',...
    'unit','pix',...
    'position',[10 270 100 22],...
    'fontsize',18,...
    'HorizontalAlignment','left',...
    'string', 'Weight [lbs]');
fig.W_box = uicontrol('style','edit',...
    'unit','pix',...
    'position',[120 270 100 22],...
    'fontsize',18,...
    'string',car.W,...
    'call);

fig.l = uicontrol('style','text',...
    'unit','pix',...
    'position',[10 240 100 22],...
    'fontsize',18,...
    'HorizontalAlignment','left',...
    'string', 'Wheelbase [in]');
fig.l_box = uicontrol('style','edit',...
    'unit','pix',...
    'position',[120 240 100 22],...
    'fontsize',18,...
    'string',car.l);

fig.h = uicontrol('style','text',...
    'unit','pix',...
    'position',[10 210 100 22],...
    'fontsize',18,...
    'HorizontalAlignment','left',...
    'string', 'CG Height [in]');
fig.h_box = uicontrol('style','edit',...
    'unit','pix',...
    'position',[120 210 100 22],...
    'fontsize',18,...
    'string',car.h);

%% Create Update Car button

fig.update_car = uicontrol('style','pushbutton',...
    'unit','pix',...
    'position',[170 40 150 24],...
    'fontsize',20,...
    'string', 'Update Car',...
    'callback', {@update_car,fig});

%% Simulate 2014 Endurance Course Lap

if ~exist('track','var')
    run('Endurance_Course.m');
end

track_time = 0;
x = [0,0];
v = [1,0];
car_position = 'above';
for i = 1:length(track)
    
    if track(i,3) == 1  % arc
        r = track(i,1);
        theta = track(i,2);
        [ t_arc, xo, vo ] = arc(x, v, r, theta, car);
        track_time = track_time + t_arc;
        x = xo;
        v = vo;
    elseif track(i,3) == 2  % slalom
        d = track(i,1);
        num = track(i,2);
        [t_slalom,xo,vo,car_position_o] = slalom(x, v, d, num, car, car_position);
        track_time = track_time + t_slalom;
        car_position = car_position_o;
        x = xo;
        v = vo;
    elseif track(i,3) == 3  % straight
        L = track(i,1);
        [t_straight, xo, vo] = straight(x, v, car, L);
        track_time = track_time+t_straight;
        x = xo;
        v = vo;
    end
    
end

fprintf('Track Time: %0.2f seconds\n', track_time)